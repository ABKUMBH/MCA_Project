pipeline {
    options {
            buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
    }
    agent any
    tools {
        maven 'maven_3.8.8'
    }
    stages{
        stage('code compile'){
            steps{
            echo 'code started compiling'
            sh 'mvn clean compile'
            echo 'code compiled successfully'
            }
        }


        stage('code package'){
            steps{
            echo 'code started packaging'
            sh 'mvn clean package -DskipTests'
            echo 'code packaged successfully'
            }
        }

        stage('Building and tag docker image'){
             steps{
             echo 'starting building docker image'
             sh 'docker build -t abkumbh/cafe:latest .'
             echo 'completed building docker image'
             }
        }

        stage('Docker Image Push to Amazon ECR') {
             steps {
             withDockerRegistry([credentialsId:'ecr:us-east-1:users3', url:"https://804475515851.dkr.ecr.us-east-1.amazonaws.com"]) {
              echo "List the docker images present in local"
              sh 'docker images'
              echo "Tagging the Docker Image: In Progress"
              sh 'docker tag abkumbh/cafe:latest 804475515851.dkr.ecr.us-east-1.amazonaws.com/cafe:latest'
              echo "Tagging the Docker Image: Completed"
              echo "Pushing Docker Image to ECR: In Progress"
              sh 'docker push 804475515851.dkr.ecr.us-east-1.amazonaws.com/cafe:latest'
              echo "Pushing Docker Image to ECR: Completed"
              }
              }
        }
    }
}